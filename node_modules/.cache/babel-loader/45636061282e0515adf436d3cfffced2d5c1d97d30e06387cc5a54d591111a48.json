{"ast":null,"code":"import{useEffect,useState,useRef}from'react';import{useNavigate,useLocation}from'react-router-dom';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";function TelegramLogin(){var _location$state;const[user,setUser]=useState(()=>{const saved=localStorage.getItem('telegramUser');return saved?JSON.parse(saved):null;});const[error,setError]=useState(null);const widgetRef=useRef(null);const navigate=useNavigate();const location=useLocation();const from=((_location$state=location.state)===null||_location$state===void 0?void 0:_location$state.from)||\"/\";useEffect(()=>{async function checkAuth(){try{const res=await fetch('http://storysight.ru:8000/auth/me',{credentials:'include'});if(res.ok){const data=await res.json();console.log('Пользователь авторизован:',data);navigate(from,{replace:true});}else{console.log('Пользователь не авторизован');}}catch(err){console.error('Ошибка при проверке авторизации:',err);}}checkAuth();},[navigate,from]);useEffect(()=>{window.onTelegramAuth=function(user){console.log('Telegram user:',user);setUser(user);localStorage.setItem('telegramUser',JSON.stringify(user));fetch('http://storysight.ru:8000/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(user)}).then(res=>res.json()).then(data=>{console.log('Ответ от сервера:',data);setError(null);navigate(from,{replace:true});}).catch(err=>{console.error('Ошибка при отправке на сервер:',err);setError('Ошибка при сохранении пользователя на сервере');});};if(!user&&widgetRef.current){widgetRef.current.innerHTML='';const script=document.createElement('script');script.src='https://telegram.org/js/telegram-widget.js?7';script.setAttribute('data-telegram-login','zavod_worker_bot');script.setAttribute('data-size','large');script.setAttribute('data-userpic','false');script.setAttribute('data-lang','ru');script.setAttribute('data-request-access','write');script.setAttribute('data-onauth','onTelegramAuth(user)');script.async=true;widgetRef.current.appendChild(script);}},[user,from,navigate]);function logout(){setUser(null);setError(null);localStorage.removeItem('telegramUser');fetch('http://storysight.ru:8000/auth/logout',{method:'POST',credentials:'include'}).then(()=>{console.log('Выход выполнен');}).catch(err=>{console.error('Ошибка при выходе:',err);});}return/*#__PURE__*/_jsxs(\"div\",{style:styles.container,children:[/*#__PURE__*/_jsx(\"h1\",{style:styles.title,children:\"\\u0412\\u0445\\u043E\\u0434 \\u0447\\u0435\\u0440\\u0435\\u0437 Telegram\"}),error&&/*#__PURE__*/_jsx(\"p\",{style:{color:'red'},children:error}),user?/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsxs(\"p\",{children:[\"\\u0412\\u044B \\u0432\\u043E\\u0448\\u043B\\u0438 \\u043A\\u0430\\u043A: \",/*#__PURE__*/_jsx(\"b\",{children:user.first_name||user.username||'Пользователь'})]}),user.photo_url&&/*#__PURE__*/_jsx(\"img\",{src:user.photo_url,alt:\"avatar\",style:{borderRadius:'50%',width:80,height:80,marginBottom:10}}),/*#__PURE__*/_jsx(\"button\",{onClick:logout,style:styles.logoutButton,children:\"\\u0412\\u044B\\u0439\\u0442\\u0438\"})]}):/*#__PURE__*/_jsx(\"div\",{id:\"telegram-button\",ref:widgetRef})]});}const styles={container:{fontFamily:'\"Comic Neue\", sans-serif',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',minHeight:'100vh',background:'linear-gradient(to right, #fcb1e2, #b49fef)',textAlign:'center'},title:{fontSize:'2rem',marginBottom:'2rem',color:'#333'},logoutButton:{padding:'10px 25px',fontSize:'16px',borderRadius:'8px',border:'none',backgroundColor:'#9b59b6',color:'white',cursor:'pointer'}};export default TelegramLogin;","map":{"version":3,"names":["useEffect","useState","useRef","useNavigate","useLocation","jsx","_jsx","jsxs","_jsxs","TelegramLogin","_location$state","user","setUser","saved","localStorage","getItem","JSON","parse","error","setError","widgetRef","navigate","location","from","state","checkAuth","res","fetch","credentials","ok","data","json","console","log","replace","err","window","onTelegramAuth","setItem","stringify","method","headers","body","then","catch","current","innerHTML","script","document","createElement","src","setAttribute","async","appendChild","logout","removeItem","style","styles","container","children","title","color","first_name","username","photo_url","alt","borderRadius","width","height","marginBottom","onClick","logoutButton","id","ref","fontFamily","display","flexDirection","alignItems","justifyContent","minHeight","background","textAlign","fontSize","padding","border","backgroundColor","cursor"],"sources":["/var/www/storysight/src/pages/TelegramLogin.jsx"],"sourcesContent":["import { useEffect, useState, useRef } from 'react';\nimport { useNavigate, useLocation } from 'react-router-dom';\n\nfunction TelegramLogin() {\n  const [user, setUser] = useState(() => {\n    const saved = localStorage.getItem('telegramUser');\n    return saved ? JSON.parse(saved) : null;\n  });\n  const [error, setError] = useState(null);\n  const widgetRef = useRef(null);\n  const navigate = useNavigate();\n  const location = useLocation();\n\n  const from = location.state?.from || \"/\";\n\n  useEffect(() => {\n    async function checkAuth() {\n      try {\n        const res = await fetch('http://storysight.ru:8000/auth/me', {\n          credentials: 'include'\n        });\n        if (res.ok) {\n          const data = await res.json();\n          console.log('Пользователь авторизован:', data);\n          navigate(from, { replace: true });\n        } else {\n          console.log('Пользователь не авторизован');\n        }\n      } catch (err) {\n        console.error('Ошибка при проверке авторизации:', err);\n      }\n    }\n\n    checkAuth();\n  }, [navigate, from]);\n\n  useEffect(() => {\n    window.onTelegramAuth = function (user) {\n      console.log('Telegram user:', user);\n      setUser(user);\n      localStorage.setItem('telegramUser', JSON.stringify(user));\n\n      fetch('http://storysight.ru:8000/auth/login', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        credentials: 'include',\n        body: JSON.stringify(user)\n      })\n        .then(res => res.json())\n        .then(data => {\n          console.log('Ответ от сервера:', data);\n          setError(null);\n          navigate(from, { replace: true });\n        })\n        .catch(err => {\n          console.error('Ошибка при отправке на сервер:', err);\n          setError('Ошибка при сохранении пользователя на сервере');\n        });\n    };\n\n    if (!user && widgetRef.current) {\n      widgetRef.current.innerHTML = '';\n\n      const script = document.createElement('script');\n      script.src = 'https://telegram.org/js/telegram-widget.js?7';\n      script.setAttribute('data-telegram-login', 'zavod_worker_bot');\n      script.setAttribute('data-size', 'large');\n      script.setAttribute('data-userpic', 'false');\n      script.setAttribute('data-lang', 'ru');\n      script.setAttribute('data-request-access', 'write');\n      script.setAttribute('data-onauth', 'onTelegramAuth(user)');\n      script.async = true;\n\n      widgetRef.current.appendChild(script);\n    }\n  }, [user, from, navigate]);\n\n  function logout() {\n    setUser(null);\n    setError(null);\n    localStorage.removeItem('telegramUser');\n\n    fetch('http://storysight.ru:8000/auth/logout', {\n      method: 'POST',\n      credentials: 'include',\n    })\n      .then(() => {\n        console.log('Выход выполнен');\n      })\n      .catch(err => {\n        console.error('Ошибка при выходе:', err);\n      });\n  }\n\n  return (\n    <div style={styles.container}>\n      <h1 style={styles.title}>Вход через Telegram</h1>\n\n      {error && <p style={{ color: 'red' }}>{error}</p>}\n\n      {user ? (\n        <div>\n          <p>Вы вошли как: <b>{user.first_name || user.username || 'Пользователь'}</b></p>\n          {user.photo_url && (\n            <img\n              src={user.photo_url}\n              alt=\"avatar\"\n              style={{ borderRadius: '50%', width: 80, height: 80, marginBottom: 10 }}\n            />\n          )}\n          <button onClick={logout} style={styles.logoutButton}>Выйти</button>\n        </div>\n      ) : (\n        <div id=\"telegram-button\" ref={widgetRef}></div>\n      )}\n    </div>\n  );\n}\n\nconst styles = {\n  container: {\n    fontFamily: '\"Comic Neue\", sans-serif',\n    display: 'flex',\n    flexDirection: 'column',\n    alignItems: 'center',\n    justifyContent: 'center',\n    minHeight: '100vh',\n    background: 'linear-gradient(to right, #fcb1e2, #b49fef)',\n    textAlign: 'center',\n  },\n  title: {\n    fontSize: '2rem',\n    marginBottom: '2rem',\n    color: '#333',\n  },\n  logoutButton: {\n    padding: '10px 25px',\n    fontSize: '16px',\n    borderRadius: '8px',\n    border: 'none',\n    backgroundColor: '#9b59b6',\n    color: 'white',\n    cursor: 'pointer',\n  },\n};\n\nexport default TelegramLogin;\n"],"mappings":"AAAA,OAASA,SAAS,CAAEC,QAAQ,CAAEC,MAAM,KAAQ,OAAO,CACnD,OAASC,WAAW,CAAEC,WAAW,KAAQ,kBAAkB,CAAC,OAAAC,GAAA,IAAAC,IAAA,CAAAC,IAAA,IAAAC,KAAA,yBAE5D,QAAS,CAAAC,aAAaA,CAAA,CAAG,KAAAC,eAAA,CACvB,KAAM,CAACC,IAAI,CAAEC,OAAO,CAAC,CAAGX,QAAQ,CAAC,IAAM,CACrC,KAAM,CAAAY,KAAK,CAAGC,YAAY,CAACC,OAAO,CAAC,cAAc,CAAC,CAClD,MAAO,CAAAF,KAAK,CAAGG,IAAI,CAACC,KAAK,CAACJ,KAAK,CAAC,CAAG,IAAI,CACzC,CAAC,CAAC,CACF,KAAM,CAACK,KAAK,CAAEC,QAAQ,CAAC,CAAGlB,QAAQ,CAAC,IAAI,CAAC,CACxC,KAAM,CAAAmB,SAAS,CAAGlB,MAAM,CAAC,IAAI,CAAC,CAC9B,KAAM,CAAAmB,QAAQ,CAAGlB,WAAW,CAAC,CAAC,CAC9B,KAAM,CAAAmB,QAAQ,CAAGlB,WAAW,CAAC,CAAC,CAE9B,KAAM,CAAAmB,IAAI,CAAG,EAAAb,eAAA,CAAAY,QAAQ,CAACE,KAAK,UAAAd,eAAA,iBAAdA,eAAA,CAAgBa,IAAI,GAAI,GAAG,CAExCvB,SAAS,CAAC,IAAM,CACd,cAAe,CAAAyB,SAASA,CAAA,CAAG,CACzB,GAAI,CACF,KAAM,CAAAC,GAAG,CAAG,KAAM,CAAAC,KAAK,CAAC,mCAAmC,CAAE,CAC3DC,WAAW,CAAE,SACf,CAAC,CAAC,CACF,GAAIF,GAAG,CAACG,EAAE,CAAE,CACV,KAAM,CAAAC,IAAI,CAAG,KAAM,CAAAJ,GAAG,CAACK,IAAI,CAAC,CAAC,CAC7BC,OAAO,CAACC,GAAG,CAAC,2BAA2B,CAAEH,IAAI,CAAC,CAC9CT,QAAQ,CAACE,IAAI,CAAE,CAAEW,OAAO,CAAE,IAAK,CAAC,CAAC,CACnC,CAAC,IAAM,CACLF,OAAO,CAACC,GAAG,CAAC,6BAA6B,CAAC,CAC5C,CACF,CAAE,MAAOE,GAAG,CAAE,CACZH,OAAO,CAACd,KAAK,CAAC,kCAAkC,CAAEiB,GAAG,CAAC,CACxD,CACF,CAEAV,SAAS,CAAC,CAAC,CACb,CAAC,CAAE,CAACJ,QAAQ,CAAEE,IAAI,CAAC,CAAC,CAEpBvB,SAAS,CAAC,IAAM,CACdoC,MAAM,CAACC,cAAc,CAAG,SAAU1B,IAAI,CAAE,CACtCqB,OAAO,CAACC,GAAG,CAAC,gBAAgB,CAAEtB,IAAI,CAAC,CACnCC,OAAO,CAACD,IAAI,CAAC,CACbG,YAAY,CAACwB,OAAO,CAAC,cAAc,CAAEtB,IAAI,CAACuB,SAAS,CAAC5B,IAAI,CAAC,CAAC,CAE1DgB,KAAK,CAAC,sCAAsC,CAAE,CAC5Ca,MAAM,CAAE,MAAM,CACdC,OAAO,CAAE,CACP,cAAc,CAAE,kBAClB,CAAC,CACDb,WAAW,CAAE,SAAS,CACtBc,IAAI,CAAE1B,IAAI,CAACuB,SAAS,CAAC5B,IAAI,CAC3B,CAAC,CAAC,CACCgC,IAAI,CAACjB,GAAG,EAAIA,GAAG,CAACK,IAAI,CAAC,CAAC,CAAC,CACvBY,IAAI,CAACb,IAAI,EAAI,CACZE,OAAO,CAACC,GAAG,CAAC,mBAAmB,CAAEH,IAAI,CAAC,CACtCX,QAAQ,CAAC,IAAI,CAAC,CACdE,QAAQ,CAACE,IAAI,CAAE,CAAEW,OAAO,CAAE,IAAK,CAAC,CAAC,CACnC,CAAC,CAAC,CACDU,KAAK,CAACT,GAAG,EAAI,CACZH,OAAO,CAACd,KAAK,CAAC,gCAAgC,CAAEiB,GAAG,CAAC,CACpDhB,QAAQ,CAAC,+CAA+C,CAAC,CAC3D,CAAC,CAAC,CACN,CAAC,CAED,GAAI,CAACR,IAAI,EAAIS,SAAS,CAACyB,OAAO,CAAE,CAC9BzB,SAAS,CAACyB,OAAO,CAACC,SAAS,CAAG,EAAE,CAEhC,KAAM,CAAAC,MAAM,CAAGC,QAAQ,CAACC,aAAa,CAAC,QAAQ,CAAC,CAC/CF,MAAM,CAACG,GAAG,CAAG,8CAA8C,CAC3DH,MAAM,CAACI,YAAY,CAAC,qBAAqB,CAAE,kBAAkB,CAAC,CAC9DJ,MAAM,CAACI,YAAY,CAAC,WAAW,CAAE,OAAO,CAAC,CACzCJ,MAAM,CAACI,YAAY,CAAC,cAAc,CAAE,OAAO,CAAC,CAC5CJ,MAAM,CAACI,YAAY,CAAC,WAAW,CAAE,IAAI,CAAC,CACtCJ,MAAM,CAACI,YAAY,CAAC,qBAAqB,CAAE,OAAO,CAAC,CACnDJ,MAAM,CAACI,YAAY,CAAC,aAAa,CAAE,sBAAsB,CAAC,CAC1DJ,MAAM,CAACK,KAAK,CAAG,IAAI,CAEnBhC,SAAS,CAACyB,OAAO,CAACQ,WAAW,CAACN,MAAM,CAAC,CACvC,CACF,CAAC,CAAE,CAACpC,IAAI,CAAEY,IAAI,CAAEF,QAAQ,CAAC,CAAC,CAE1B,QAAS,CAAAiC,MAAMA,CAAA,CAAG,CAChB1C,OAAO,CAAC,IAAI,CAAC,CACbO,QAAQ,CAAC,IAAI,CAAC,CACdL,YAAY,CAACyC,UAAU,CAAC,cAAc,CAAC,CAEvC5B,KAAK,CAAC,uCAAuC,CAAE,CAC7Ca,MAAM,CAAE,MAAM,CACdZ,WAAW,CAAE,SACf,CAAC,CAAC,CACCe,IAAI,CAAC,IAAM,CACVX,OAAO,CAACC,GAAG,CAAC,gBAAgB,CAAC,CAC/B,CAAC,CAAC,CACDW,KAAK,CAACT,GAAG,EAAI,CACZH,OAAO,CAACd,KAAK,CAAC,oBAAoB,CAAEiB,GAAG,CAAC,CAC1C,CAAC,CAAC,CACN,CAEA,mBACE3B,KAAA,QAAKgD,KAAK,CAAEC,MAAM,CAACC,SAAU,CAAAC,QAAA,eAC3BrD,IAAA,OAAIkD,KAAK,CAAEC,MAAM,CAACG,KAAM,CAAAD,QAAA,CAAC,kEAAmB,CAAI,CAAC,CAEhDzC,KAAK,eAAIZ,IAAA,MAAGkD,KAAK,CAAE,CAAEK,KAAK,CAAE,KAAM,CAAE,CAAAF,QAAA,CAAEzC,KAAK,CAAI,CAAC,CAEhDP,IAAI,cACHH,KAAA,QAAAmD,QAAA,eACEnD,KAAA,MAAAmD,QAAA,EAAG,kEAAc,cAAArD,IAAA,MAAAqD,QAAA,CAAIhD,IAAI,CAACmD,UAAU,EAAInD,IAAI,CAACoD,QAAQ,EAAI,cAAc,CAAI,CAAC,EAAG,CAAC,CAC/EpD,IAAI,CAACqD,SAAS,eACb1D,IAAA,QACE4C,GAAG,CAAEvC,IAAI,CAACqD,SAAU,CACpBC,GAAG,CAAC,QAAQ,CACZT,KAAK,CAAE,CAAEU,YAAY,CAAE,KAAK,CAAEC,KAAK,CAAE,EAAE,CAAEC,MAAM,CAAE,EAAE,CAAEC,YAAY,CAAE,EAAG,CAAE,CACzE,CACF,cACD/D,IAAA,WAAQgE,OAAO,CAAEhB,MAAO,CAACE,KAAK,CAAEC,MAAM,CAACc,YAAa,CAAAZ,QAAA,CAAC,gCAAK,CAAQ,CAAC,EAChE,CAAC,cAENrD,IAAA,QAAKkE,EAAE,CAAC,iBAAiB,CAACC,GAAG,CAAErD,SAAU,CAAM,CAChD,EACE,CAAC,CAEV,CAEA,KAAM,CAAAqC,MAAM,CAAG,CACbC,SAAS,CAAE,CACTgB,UAAU,CAAE,0BAA0B,CACtCC,OAAO,CAAE,MAAM,CACfC,aAAa,CAAE,QAAQ,CACvBC,UAAU,CAAE,QAAQ,CACpBC,cAAc,CAAE,QAAQ,CACxBC,SAAS,CAAE,OAAO,CAClBC,UAAU,CAAE,6CAA6C,CACzDC,SAAS,CAAE,QACb,CAAC,CACDrB,KAAK,CAAE,CACLsB,QAAQ,CAAE,MAAM,CAChBb,YAAY,CAAE,MAAM,CACpBR,KAAK,CAAE,MACT,CAAC,CACDU,YAAY,CAAE,CACZY,OAAO,CAAE,WAAW,CACpBD,QAAQ,CAAE,MAAM,CAChBhB,YAAY,CAAE,KAAK,CACnBkB,MAAM,CAAE,MAAM,CACdC,eAAe,CAAE,SAAS,CAC1BxB,KAAK,CAAE,OAAO,CACdyB,MAAM,CAAE,SACV,CACF,CAAC,CAED,cAAe,CAAA7E,aAAa","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}
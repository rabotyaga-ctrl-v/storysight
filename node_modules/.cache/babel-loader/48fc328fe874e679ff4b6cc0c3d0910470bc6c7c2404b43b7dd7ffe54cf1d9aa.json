{"ast":null,"code":"import React,{useEffect,useRef,useState}from\"react\";import{useNavigate}from\"react-router-dom\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const Home=()=>{const navigate=useNavigate();const telegramRef=useRef(null);const[user,setUser]=useState(null);// Функция для обработки авторизации через Telegram Login Widget\nwindow.TelegramLoginWidgetCallback=async function(userData){console.log(\"Telegram login data:\",userData);// Отправляем данные на backend для логина/регистрации\ntry{const res=await fetch(\"http://storysight.ru/auth/login\",{method:\"POST\",headers:{\"Content-Type\":\"application/json\"},credentials:\"include\",// важно, чтобы куки сохранились\nbody:JSON.stringify(userData)});if(!res.ok)throw new Error(\"Ошибка логина\");const data=await res.json();console.log(\"Login response:\",data);// Сохраняем данные пользователя в состояние\nsetUser({id:userData.id,username:userData.username,first_name:userData.first_name,last_name:userData.last_name,photo_url:userData.photo_url});}catch(e){console.error(\"Login failed:\",e);}};useEffect(()=>{if(telegramRef.current){telegramRef.current.innerHTML=\"\";const script=document.createElement(\"script\");script.src=\"https://telegram.org/js/telegram-widget.js?22\";script.setAttribute(\"data-telegram-login\",\"zavod_worker_bot\");script.setAttribute(\"data-size\",\"large\");script.setAttribute(\"data-userpic\",\"true\");script.setAttribute(\"data-lang\",\"ru\");script.setAttribute(\"data-request-access\",\"write\");// ВАЖНО: **не указываем data-auth-url!**\n// Указываем callback-функцию для обработки\nscript.setAttribute(\"data-onauth\",\"TelegramLoginWidgetCallback(user)\");script.async=true;telegramRef.current.appendChild(script);}},[]);useEffect(()=>{// при монтировании пытаемся получить текущего пользователя с сервера\nfetch(\"http://storysight.ru/auth/me\",{credentials:\"include\"}).then(res=>{if(!res.ok)throw new Error(\"Не авторизован\");return res.json();}).then(data=>{setUser(data);}).catch(()=>{setUser(null);});},[]);// Функция выхода — удаляем куки и очищаем состояние\nconst logout=async()=>{await fetch(\"http://storysight.ru/auth/logout\",{method:\"POST\",credentials:\"include\"});setUser(null);};return/*#__PURE__*/_jsxs(\"div\",{className:\"home-container\",children:[/*#__PURE__*/_jsxs(\"nav\",{className:\"top-tabs\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"tab\",onClick:()=>navigate(\"/generate-character\"),children:\"\\u041A\\u043E\\u043D\\u0441\\u0442\\u0440\\u0443\\u043A\\u0442\\u043E\\u0440 \\u043F\\u0435\\u0440\\u0441\\u043E\\u043D\\u0430\\u0436\\u0430\"}),/*#__PURE__*/_jsx(\"span\",{className:\"tab\",onClick:()=>navigate(\"/my-projects\"),children:\"\\u041C\\u043E\\u0438 \\u043F\\u0440\\u043E\\u0435\\u043A\\u0442\\u044B\"})]}),/*#__PURE__*/_jsxs(\"main\",{className:\"main-content\",children:[/*#__PURE__*/_jsx(\"h1\",{className:\"headline\",children:\"\\u0421\\u043E\\u0437\\u0434\\u0430\\u0439 \\u0441\\u0432\\u043E\\u044E \\u0438\\u0441\\u0442\\u043E\\u0440\\u0438\\u044E\"}),/*#__PURE__*/_jsx(\"p\",{className:\"subtitle\",children:\"\\u0421\\u0434\\u0435\\u043B\\u0430\\u0439 \\u0437\\u0430\\u043F\\u043E\\u043C\\u0438\\u043D\\u0430\\u044E\\u0449\\u0443\\u044E\\u0441\\u044F \\u0438\\u0441\\u0442\\u043E\\u0440\\u0438\\u044E \\u0434\\u043B\\u044F \\u0441\\u0432\\u043E\\u0435\\u0433\\u043E \\u0431\\u0438\\u0437\\u043D\\u0435\\u0441\\u0430 \\u0437\\u0430 3 \\u0448\\u0430\\u0433\\u0430.\"}),/*#__PURE__*/_jsx(\"div\",{className:\"button-telegram-wrapper\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"button-group\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"btn\",onClick:()=>navigate(\"/create-choice\"),children:\"\\u041D\\u0430\\u0447\\u0430\\u0442\\u044C\"}),user?/*#__PURE__*/_jsxs(\"div\",{className:\"user-info\",children:[/*#__PURE__*/_jsx(\"img\",{src:user.photo_url,alt:user.first_name,style:{width:48,borderRadius:\"50%\",marginRight:10}}),/*#__PURE__*/_jsx(\"span\",{children:user.first_name||user.username}),/*#__PURE__*/_jsx(\"button\",{className:\"btn-logout\",onClick:logout,children:\"\\u0412\\u044B\\u0439\\u0442\\u0438\"})]}):/*#__PURE__*/_jsx(\"div\",{className:\"telegram-login\",ref:telegramRef})]})})]})]});};export default Home;","map":{"version":3,"names":["React","useEffect","useRef","useState","useNavigate","jsx","_jsx","jsxs","_jsxs","Home","navigate","telegramRef","user","setUser","window","TelegramLoginWidgetCallback","userData","console","log","res","fetch","method","headers","credentials","body","JSON","stringify","ok","Error","data","json","id","username","first_name","last_name","photo_url","e","error","current","innerHTML","script","document","createElement","src","setAttribute","async","appendChild","then","catch","logout","className","children","onClick","alt","style","width","borderRadius","marginRight","ref"],"sources":["/var/www/storysight/src/pages/Home.jsx"],"sourcesContent":["import React, { useEffect, useRef, useState } from \"react\";\nimport { useNavigate } from \"react-router-dom\";\n\nconst Home = () => {\n  const navigate = useNavigate();\n  const telegramRef = useRef(null);\n\n  const [user, setUser] = useState(null);\n\n  // Функция для обработки авторизации через Telegram Login Widget\n  window.TelegramLoginWidgetCallback = async function (userData) {\n    console.log(\"Telegram login data:\", userData);\n\n    // Отправляем данные на backend для логина/регистрации\n    try {\n      const res = await fetch(\"http://storysight.ru/auth/login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\", // важно, чтобы куки сохранились\n        body: JSON.stringify(userData),\n      });\n\n      if (!res.ok) throw new Error(\"Ошибка логина\");\n\n      const data = await res.json();\n      console.log(\"Login response:\", data);\n\n      // Сохраняем данные пользователя в состояние\n      setUser({\n        id: userData.id,\n        username: userData.username,\n        first_name: userData.first_name,\n        last_name: userData.last_name,\n        photo_url: userData.photo_url,\n      });\n    } catch (e) {\n      console.error(\"Login failed:\", e);\n    }\n  };\n\n  useEffect(() => {\n    if (telegramRef.current) {\n      telegramRef.current.innerHTML = \"\";\n\n      const script = document.createElement(\"script\");\n      script.src = \"https://telegram.org/js/telegram-widget.js?22\";\n      script.setAttribute(\"data-telegram-login\", \"zavod_worker_bot\");\n      script.setAttribute(\"data-size\", \"large\");\n      script.setAttribute(\"data-userpic\", \"true\");\n      script.setAttribute(\"data-lang\", \"ru\");\n      script.setAttribute(\"data-request-access\", \"write\");\n      // ВАЖНО: **не указываем data-auth-url!**\n\n      // Указываем callback-функцию для обработки\n      script.setAttribute(\"data-onauth\", \"TelegramLoginWidgetCallback(user)\");\n\n      script.async = true;\n\n      telegramRef.current.appendChild(script);\n    }\n  }, []);\n\n  useEffect(() => {\n  // при монтировании пытаемся получить текущего пользователя с сервера\n  fetch(\"http://storysight.ru/auth/me\", {\n    credentials: \"include\",\n  })\n    .then(res => {\n      if (!res.ok) throw new Error(\"Не авторизован\");\n      return res.json();\n    })\n    .then(data => {\n      setUser(data);\n    })\n    .catch(() => {\n      setUser(null);\n    });\n   }, []);\n\n  // Функция выхода — удаляем куки и очищаем состояние\n  const logout = async () => {\n    await fetch(\"http://storysight.ru/auth/logout\", {\n      method: \"POST\",\n      credentials: \"include\",\n    });\n    setUser(null);\n  };\n\n  return (\n    <div className=\"home-container\">\n      <nav className=\"top-tabs\">\n        <span className=\"tab\" onClick={() => navigate(\"/generate-character\")}>\n          Конструктор персонажа\n        </span>\n        <span className=\"tab\" onClick={() => navigate(\"/my-projects\")}>\n          Мои проекты\n        </span>\n      </nav>\n\n      <main className=\"main-content\">\n        <h1 className=\"headline\">Создай свою историю</h1>\n        <p className=\"subtitle\">Сделай запоминающуюся историю для своего бизнеса за 3 шага.</p>\n\n        <div className=\"button-telegram-wrapper\">\n          <div className=\"button-group\">\n            <button className=\"btn\" onClick={() => navigate(\"/create-choice\")}>\n              Начать\n            </button>\n\n            {user ? (\n              <div className=\"user-info\">\n                <img\n                  src={user.photo_url}\n                  alt={user.first_name}\n                  style={{ width: 48, borderRadius: \"50%\", marginRight: 10 }}\n                />\n                <span>{user.first_name || user.username}</span>\n                <button className=\"btn-logout\" onClick={logout}>\n                  Выйти\n                </button>\n              </div>\n            ) : (\n              <div className=\"telegram-login\" ref={telegramRef}></div>\n            )}\n          </div>\n        </div>\n      </main>\n\n      {/* остальной код */}\n    </div>\n  );\n};\n\nexport default Home;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}
{"ast":null,"code":"import{useEffect,useState,useRef}from'react';import{useNavigate,useLocation}from'react-router-dom';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";function TelegramLogin(){var _location$state;const[user,setUser]=useState(null);const[loading,setLoading]=useState(true);// Добавляем загрузку статуса\nconst[error,setError]=useState(null);const widgetRef=useRef(null);const navigate=useNavigate();const location=useLocation();const from=((_location$state=location.state)===null||_location$state===void 0?void 0:_location$state.from)||\"/\";// Проверяем статус авторизации при монтировании\nuseEffect(()=>{fetch('http://storysight.ru:8000/auth/me',{credentials:'include'}).then(res=>{if(res.status===200)return res.json();else throw new Error('Неавторизован');}).then(data=>{setUser(data);}).catch(()=>{setUser(null);}).finally(()=>{setLoading(false);});},[]);// Редиректим только если загрузка закончилась и пользователь залогинен\nuseEffect(()=>{if(!loading&&user){navigate(from,{replace:true});}},[loading,user,from,navigate]);useEffect(()=>{window.onTelegramAuth=function(user){console.log('Telegram user:',user);setUser(user);localStorage.setItem('telegramUser',JSON.stringify(user));fetch('http://storysight.ru:8000/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(user)}).then(res=>res.json()).then(data=>{console.log('Ответ от сервера:',data);setError(null);setUser(user);// устанавливаем user при успешном логине\n}).catch(err=>{console.error('Ошибка при отправке на сервер:',err);setError('Ошибка при сохранении пользователя на сервере');});};if(!user&&widgetRef.current){widgetRef.current.innerHTML='';const script=document.createElement('script');script.src='https://telegram.org/js/telegram-widget.js?7';script.setAttribute('data-telegram-login','zavod_worker_bot');script.setAttribute('data-size','large');script.setAttribute('data-userpic','false');script.setAttribute('data-lang','ru');script.setAttribute('data-request-access','write');script.setAttribute('data-onauth','onTelegramAuth(user)');script.async=true;widgetRef.current.appendChild(script);}},[user]);function logout(){setUser(null);setError(null);localStorage.removeItem('telegramUser');fetch('http://storysight.ru:8000/auth/logout',{credentials:'include'});// Можно добавить logout на бэкенде\n}if(loading){return/*#__PURE__*/_jsx(\"p\",{children:\"\\u0417\\u0430\\u0433\\u0440\\u0443\\u0437\\u043A\\u0430...\"});// Пока статус не известен - показываем загрузку\n}return/*#__PURE__*/_jsxs(\"div\",{style:styles.container,children:[/*#__PURE__*/_jsx(\"h1\",{style:styles.title,children:\"\\u0412\\u0445\\u043E\\u0434 \\u0447\\u0435\\u0440\\u0435\\u0437 Telegram\"}),error&&/*#__PURE__*/_jsx(\"p\",{style:{color:'red'},children:error}),user?/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsxs(\"p\",{children:[\"\\u0412\\u044B \\u0432\\u043E\\u0448\\u043B\\u0438 \\u043A\\u0430\\u043A: \",/*#__PURE__*/_jsx(\"b\",{children:user.first_name||user.username||'Пользователь'})]}),user.photo_url&&/*#__PURE__*/_jsx(\"img\",{src:user.photo_url,alt:\"avatar\",style:{borderRadius:'50%',width:80,height:80,marginBottom:10}}),/*#__PURE__*/_jsx(\"button\",{onClick:logout,style:styles.logoutButton,children:\"\\u0412\\u044B\\u0439\\u0442\\u0438\"})]}):/*#__PURE__*/_jsx(\"div\",{id:\"telegram-button\",ref:widgetRef})]});}const styles={container:{fontFamily:'\"Comic Neue\", sans-serif',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',minHeight:'100vh',background:'linear-gradient(to right, #fcb1e2, #b49fef)',textAlign:'center'},title:{fontSize:'2rem',marginBottom:'2rem',color:'#333'},logoutButton:{padding:'10px 25px',fontSize:'16px',borderRadius:'8px',border:'none',backgroundColor:'#9b59b6',color:'white',cursor:'pointer'}};export default TelegramLogin;","map":{"version":3,"names":["useEffect","useState","useRef","useNavigate","useLocation","jsx","_jsx","jsxs","_jsxs","TelegramLogin","_location$state","user","setUser","loading","setLoading","error","setError","widgetRef","navigate","location","from","state","fetch","credentials","then","res","status","json","Error","data","catch","finally","replace","window","onTelegramAuth","console","log","localStorage","setItem","JSON","stringify","method","headers","body","err","current","innerHTML","script","document","createElement","src","setAttribute","async","appendChild","logout","removeItem","children","style","styles","container","title","color","first_name","username","photo_url","alt","borderRadius","width","height","marginBottom","onClick","logoutButton","id","ref","fontFamily","display","flexDirection","alignItems","justifyContent","minHeight","background","textAlign","fontSize","padding","border","backgroundColor","cursor"],"sources":["/var/www/storysight/src/pages/TelegramLogin.jsx"],"sourcesContent":["import { useEffect, useState, useRef } from 'react';\nimport { useNavigate, useLocation } from 'react-router-dom';\n\nfunction TelegramLogin() {\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true); // Добавляем загрузку статуса\n  const [error, setError] = useState(null);\n  const widgetRef = useRef(null);\n  const navigate = useNavigate();\n  const location = useLocation();\n\n  const from = location.state?.from || \"/\";\n\n  // Проверяем статус авторизации при монтировании\n  useEffect(() => {\n    fetch('http://storysight.ru:8000/auth/me', { credentials: 'include' })\n      .then(res => {\n        if (res.status === 200) return res.json();\n        else throw new Error('Неавторизован');\n      })\n      .then(data => {\n        setUser(data);\n      })\n      .catch(() => {\n        setUser(null);\n      })\n      .finally(() => {\n        setLoading(false);\n      });\n  }, []);\n\n  // Редиректим только если загрузка закончилась и пользователь залогинен\n  useEffect(() => {\n    if (!loading && user) {\n      navigate(from, { replace: true });\n    }\n  }, [loading, user, from, navigate]);\n\n  useEffect(() => {\n    window.onTelegramAuth = function (user) {\n      console.log('Telegram user:', user);\n      setUser(user);\n      localStorage.setItem('telegramUser', JSON.stringify(user));\n\n      fetch('http://storysight.ru:8000/auth/login', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(user)\n      })\n        .then(res => res.json())\n        .then(data => {\n          console.log('Ответ от сервера:', data);\n          setError(null);\n          setUser(user); // устанавливаем user при успешном логине\n        })\n        .catch(err => {\n          console.error('Ошибка при отправке на сервер:', err);\n          setError('Ошибка при сохранении пользователя на сервере');\n        });\n    };\n\n    if (!user && widgetRef.current) {\n      widgetRef.current.innerHTML = '';\n\n      const script = document.createElement('script');\n      script.src = 'https://telegram.org/js/telegram-widget.js?7';\n      script.setAttribute('data-telegram-login', 'zavod_worker_bot');\n      script.setAttribute('data-size', 'large');\n      script.setAttribute('data-userpic', 'false');\n      script.setAttribute('data-lang', 'ru');\n      script.setAttribute('data-request-access', 'write');\n      script.setAttribute('data-onauth', 'onTelegramAuth(user)');\n      script.async = true;\n\n      widgetRef.current.appendChild(script);\n    }\n  }, [user]);\n\n  function logout() {\n    setUser(null);\n    setError(null);\n    localStorage.removeItem('telegramUser');\n    fetch('http://storysight.ru:8000/auth/logout', { credentials: 'include' }); // Можно добавить logout на бэкенде\n  }\n\n  if (loading) {\n    return <p>Загрузка...</p>; // Пока статус не известен - показываем загрузку\n  }\n\n  return (\n    <div style={styles.container}>\n      <h1 style={styles.title}>Вход через Telegram</h1>\n\n      {error && <p style={{ color: 'red' }}>{error}</p>}\n\n      {user ? (\n        <div>\n          <p>Вы вошли как: <b>{user.first_name || user.username || 'Пользователь'}</b></p>\n          {user.photo_url && (\n            <img\n              src={user.photo_url}\n              alt=\"avatar\"\n              style={{ borderRadius: '50%', width: 80, height: 80, marginBottom: 10 }}\n            />\n          )}\n          <button onClick={logout} style={styles.logoutButton}>Выйти</button>\n        </div>\n      ) : (\n        <div id=\"telegram-button\" ref={widgetRef}></div>\n      )}\n    </div>\n  );\n}\n\nconst styles = {\n  container: {\n    fontFamily: '\"Comic Neue\", sans-serif',\n    display: 'flex',\n    flexDirection: 'column',\n    alignItems: 'center',\n    justifyContent: 'center',\n    minHeight: '100vh',\n    background: 'linear-gradient(to right, #fcb1e2, #b49fef)',\n    textAlign: 'center',\n  },\n  title: {\n    fontSize: '2rem',\n    marginBottom: '2rem',\n    color: '#333',\n  },\n  logoutButton: {\n    padding: '10px 25px',\n    fontSize: '16px',\n    borderRadius: '8px',\n    border: 'none',\n    backgroundColor: '#9b59b6',\n    color: 'white',\n    cursor: 'pointer',\n  },\n};\n\nexport default TelegramLogin;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}